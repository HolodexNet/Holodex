<template>
  <div
    id="top-bar"
    class="navbar sticky top-0 z-10 h-[56px] min-h-[56px] border-b border-bgColor-100 bg-bgColor pb-0"
    style="align-self: start"
  >
    <!--=============================== Top Bar (Regular View) =============================-->
    <template v-if="!isMobile || (isMobile && !searchBarExpanded)">
      <!--================= Logo & Search Bar (Space permitting) ================-->
      <div class="mr-2 cursor-pointer" @click.stop="$emit('toggleSidebar')">
        <logo v-if="isSmOrDown" width="32" height="32" :loading="loading > 0" />
        <!-- <div v-else class="i-ion:menu h-6 w-6" /> -->
      </div>
      <div class="mr-2 flex shrink-0 flex-row items-center gap-2">
        <router-link
          v-if="!isSmOrDown"
          :to="{ name: settings.defaultOpen || 'Home' }"
        >
          <logo width="32" height="32" :loading="loading > 0" />
        </router-link>
        <OrgSelector
          @changed="
            (org: Org, close?: Function) => {
              site.currentOrg = org;
              close && close();
            }
          "
        />
      </div>
      <!-- </v-toolbar-title> -->
      <!-- <SearchBar
          v-if="!isMobile"
          key="main-search-bar"
          class="mx-auto height-40px"
        /> -->
      <SearchBar4
        v-if="!isMobile"
        key="main-search-bar2"
        class="height-40px mx-auto"
      />

      <!--================= Account [👤] Button (Desktop Only) ================-->

      <playlist-button
        class="mr-2 flex-shrink"
        @click="playlistDrawer = !playlistDrawer"
      />
      <h-menu v-if="!isMobile" placement="bottom-end" strategy="fixed">
        <template #activator="{ props }">
          <div
            v-bind="props"
            class="btn-ghost btn-square btn mr-2 text-2xl"
            style="width: 3rem; height: 3rem; min-height: 3rem"
          >
            <h-icon
              v-if="!(site.user && site.user)"
              class="i-mdi:account-circle-outline"
            />
            <img
              v-else
              class="h-10 w-10 rounded-full"
              :src="`https://api.dicebear.com/7.x/shapes/svg?seed=${site.user.id}`"
              alt="Avatar generated by your user ID"
            />
          </div>
        </template>

        <!------- USER CARD ------->
        <user-card class="border border-bgColor-100 shadow-md drop-shadow" />
        <!------- END USER CARD ------->
      </h-menu>

      <!--================= Search [🔍] Button (Mobile Only) ================-->

      <h-btn
        v-if="isMobile"
        icon="i-material-symbols:search-rounded"
        class="btn-icon"
        @click="searchBarExpanded = true"
      />
    </template>

    <!--=========================== END OF Regular View ===========================-->

    <!--===================== Expanded Search Bar (Mobile Only) =======================-->

    <template v-else>
      <!-- <v-app-bar-nav-icon
        style="margin-left: 0px"
        @click="searchBarExpanded = false"
      >
        <v-icon>some close button icon</v-icon>
      </v-app-bar-nav-icon>
      <SearchBar key="main-search-bar" :autofocus="isMobile" class="mr-3" /> -->
    </template>

    <!--=================== END OF Expanded Search (Mobile Only) =======================-->
    <div
      :class="'primary'"
      style="
        position: absolute;
        top: calc(-1 * env(safe-area-inset-top));
        left: 0px;
        right: 0px;
        width: 100%;
        height: env(safe-area-inset-top);
        z-index: 300;
      "
    >
      <!-- this is just the element that covers up the notch. don't worry about it. -->
    </div>
  </div>
</template>

<script lang="ts">
import { useSiteStore } from "@/stores/site";
import { useSettingsStore } from "@/stores/settings";
import { useIsFetching } from "@tanstack/vue-query";
import { useDisplay } from "@/hooks/common/useDisplay";

export default defineComponent({
  components: {},
  emits: ["toggleSidebar"],
  setup() {
    const site = useSiteStore();
    const settings = useSettingsStore();
    const display = useDisplay();
    const loading = useIsFetching();

    const isMobile = display.mobile;
    const isSmOrDown = display.smaller("sm");
    const isMdOrDown = display.smaller("lg");

    return {
      site,
      display,
      isMobile,
      isSmOrDown,
      isMdOrDown,
      settings,
      loading,
    };
  },
  data() {
    return {
      favoritesExpanded: false,
      searchBarExpanded: false,
      navbarExpanded: false,

      navDrawer: true,
      playlistDrawer: false,
    };
  },
  computed: {
    showTopBar() {
      if (this.mustHideTopBar) return false;
      if (this.isMultiView) return false;
      if (this.isMobile && this.isWatchPage) {
        return false;
      }
      if (
        this.$route.name === "tlclient" ||
        this.$route.name === "scripteditor"
      ) {
        return false;
      }
      return true;
    },
    isWatchPage() {
      return [
        "watch_id",
        "watch",
        "edit_video",
        "multiview",
        "tlclient",
        "scripteditor",
      ].includes(this.$route.name as any);
    },
    isMultiView() {
      return this.$route.name === "multiview";
    },
  },
  watch: {
    // toggle navdrawer when navigating between watch pages on desktop
    isWatchPage() {
      if (this.isMobile) return;
      this.navDrawer = !this.isWatchPage;
    },
  },
  created() {
    if (this.site.guide.firstVisit) {
      setTimeout(() => {
        this.site.guide.firstVisit = false;
      }, 30000);
    }

    // always pop out nav drawer if it's not watch page or collapsed
    if (
      !window.location.pathname.match("^/watch|^/multiview|^/infinite") &&
      !this.isMdOrDown
    ) {
      this.navDrawer = true;
    }
  },
});
</script>
<style>
#playlistDrawer .v-navigation-drawer__content {
  overflow: hidden;
}
</style>
<style scoped lang="scss">
@keyframes rotation {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(359deg);
  }
}

#top-bar {
  /* background-color: #2b79ad !important; */
  // TODO: this thing
  /* padding-left: min(calc(env(safe-area-inset-left)), 30px);
  padding-right: min(calc(env(safe-area-inset-right)), 30px); */
  /* padding-top: min(calc(env(safe-area-inset-top) / 2), 30px); */
  /* height: calc(env(safe-area-inset-top,0px) + 30px); */
  padding-top: 0px;
  margin-top: env(safe-area-inset-top, 0px) !important;
  overflow: visible;
}

/* #top-bar.v-toolbar--extended {
  height: 56px !important;
} */

.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s ease;
}

.fade-enter,
.fade-leave-to {
  opacity: 0;
}
</style>
