<template>
  <span :class="'text-' + video.status" :title="absoluteTimeString">
    {{ formattedTime }}
  </span>
</template>

<script lang="ts">
import { useLangStore } from "@/stores";
import { dayjs, formatDistance, localizedDayjs } from "@/utils/time";
import { useIntervalFn } from "@vueuse/core";
import { PropType } from "vue";
import { useI18n } from "vue-i18n";

export default defineComponent({
  props: {
    video: {
      type: Object as PropType<Video>,
      required: true,
    },
  },
  setup(props) {
    const { t } = useI18n();
    const langStore = useLangStore();
    const formattedTime = ref("");
    const available_at = computed(() => props.video.available_at);
    watchEffect(() => {
      if (props.video.status == "live") {
        formattedTime.value = t("component.videoCard.liveNow");
      }
    });

    function triggerUpdate() {
      switch (props.video.status) {
        case "upcoming":
          // print relative time in hours if less than 24 hours,
          // print full date if greater than 24 hours
          formattedTime.value = formatDistance(
            props.video.start_scheduled || props.video.available_at,
            langStore.lang,
            t,
            false, // allowNegative = false
            dayjs(),
          ); // upcoming videos don't get to be ("5 minutes ago")
          return;
        case "live":
          formattedTime.value = t("component.videoCard.liveNow");
          return;
        default:
          formattedTime.value = formatDistance(
            props.video.available_at,
            langStore.lang,
            t,
            true,
            dayjs(),
          );
      }
    }

    watch(() => [available_at.value, props.video.status], triggerUpdate);

    useIntervalFn(triggerUpdate, 60 * 1000, { immediateCallback: true });

    const absoluteTimeString = computed(() => {
      const ts = localizedDayjs(available_at.value, langStore.lang);

      const ts1 = ts.format(`ddd DD LT zzz`);
      const ts2 = ts.tz("Asia/Tokyo").format(`ddd DD LT zzz`);
      if (ts1 === ts2) {
        return ts1;
      }
      return `${ts1}\n${ts2}`;
    });

    return { formattedTime, absoluteTimeString };
  },
});
</script>

<style lang="scss">
.text-live {
  color: red;
  font-weight: 500;
}
</style>
